version: '3'

# View organization profile at: https://github.com/joeblew999?preview=true

vars:
  GITHUB_ORG: joeblew999
  # Platform detection
  OS: "{{OS}}"
  ARCH: "{{ARCH}}"
  # Platform-specific extensions
  EXE_EXT: '{{if eq OS "windows"}}.exe{{end}}'
  # Platform-specific binaries
  GH_BINARY: 'gh{{.EXE_EXT}}'
  TERRAFORM_BINARY: 'terraform{{.EXE_EXT}}'
  NATS_BINARY: 'nats{{.EXE_EXT}}'
  # Platform-specific paths
  HOME_DIR: '{{if eq OS "windows"}}{{.USERPROFILE}}{{else}}{{.HOME}}{{end}}'

tasks:
  default:
    desc: List available tasks
    cmds:
      - |
        echo "ğŸ› ï¸  GitHub Organization Setup Tool"
        echo "Platform: {{.OS}}/{{.ARCH}}"
        echo "Organization: {{.GITHUB_ORG}}"
        echo ""
      - task --list

  setup:
    desc: Create .github structure from templates
    cmds:
      - task: clean
      - mkdir -p .github profile
      - go run cmd/github-setup/main.go -org={{.GITHUB_ORG}}

  clean:
    desc: Remove generated .github files
    cmds:
      - rm -rf .github/ISSUE_TEMPLATE .github/issue-templates .github/workflows .github/CODEOWNERS .github/dependabot.yml .github/pull_request_template.md .github/PULL_REQUEST_TEMPLATE

  check:
    desc: Check if generated files are up to date with templates
    cmds:
      - |
        echo "Checking if generated files are up to date..."
        TEMP_DIR=$(mktemp -d)
        go run cmd/github-setup/main.go -org={{.GITHUB_ORG}} -output="$TEMP_DIR"
        if ! diff -r .github "$TEMP_DIR" > /dev/null 2>&1; then
          echo "âŒ Generated files are out of date. Run 'task setup' to update."
          rm -rf "$TEMP_DIR"
          exit 1
        else
          echo "âœ… Generated files are up to date."
          rm -rf "$TEMP_DIR"
        fi

  install-gh:
    desc: Ensure GitHub CLI is installed (idempotent, cross-platform)
    cmds:
      - |
        echo "ğŸ“¦ Installing GitHub CLI for {{.OS}}/{{.ARCH}}..."
        
        if command -v {{.GH_BINARY}} >/dev/null 2>&1; then
          echo "âœ… GitHub CLI already installed: $({{.GH_BINARY}} --version | head -1)"
        else
          echo "ğŸ“¦ Installing GitHub CLI..."
          
          {{if eq .OS "darwin"}}
          # macOS via Homebrew
          if command -v brew >/dev/null 2>&1; then
            brew install gh
          else
            echo "âŒ Homebrew not found. Install from: https://brew.sh/"
            exit 1
          fi
          
          {{else if eq .OS "linux"}}
          # Linux via package manager
          if command -v apt >/dev/null 2>&1; then
            # Debian/Ubuntu
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install gh
          elif command -v yum >/dev/null 2>&1; then
            # RHEL/CentOS/Fedora
            sudo yum install -y yum-utils
            sudo yum-config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
            sudo yum install gh
          elif command -v pacman >/dev/null 2>&1; then
            # Arch Linux
            sudo pacman -S github-cli
          else
            echo "âŒ Unsupported Linux distribution. Install manually: https://cli.github.com/"
            exit 1
          fi
          
          {{else if eq .OS "windows"}}
          # Windows via package manager
          if command -v choco >/dev/null 2>&1; then
            choco install gh
          elif command -v scoop >/dev/null 2>&1; then
            scoop install gh
          elif command -v winget >/dev/null 2>&1; then
            winget install --id GitHub.cli
          else
            echo "âŒ No package manager found (choco/scoop/winget). Install from: https://cli.github.com/"
            exit 1
          fi
          
          {{else}}
          echo "âŒ Unsupported OS: {{.OS}}. Please install GitHub CLI manually: https://cli.github.com/"
          exit 1
          {{end}}
          
          echo "âœ… GitHub CLI installed: $({{.GH_BINARY}} --version | head -1)"
        fi

  verify-github:
    desc: Verify repository state on GitHub matches local templates
    deps: [install-gh]
    cmds:
      - |
        echo "ğŸ” Verifying GitHub repository state..."
        
        # Check if repo exists and is accessible
        if ! gh repo view {{.GITHUB_ORG}}/.github >/dev/null 2>&1; then
          echo "âŒ Cannot access repository {{.GITHUB_ORG}}/.github"
          exit 1
        fi
        
        echo "âœ… Repository {{.GITHUB_ORG}}/.github is accessible"
        
        # Check if workflows are enabled
        echo "ğŸ“‹ Checking workflows..."
        gh workflow list --repo {{.GITHUB_ORG}}/.github
        
        # Check if issues/PRs use our templates
        echo "ğŸ“ Checking if templates are active..."
        echo "  Issue templates:"
        gh api repos/{{.GITHUB_ORG}}/.github/contents/.github/ISSUE_TEMPLATE --jq '.[].name' 2>/dev/null || \
        gh api repos/{{.GITHUB_ORG}}/.github/contents/.github/issue-templates --jq '.[].name' 2>/dev/null || \
        echo "    No issue templates found"
        
        # Check organization profile
        echo "ğŸ¢ Organization profile:"
        gh api orgs/{{.GITHUB_ORG}} --jq '.name // .login' 2>/dev/null || \
        echo "    Organization API requires admin:org scope"
        
        # Check if dependabot is configured
        echo "ğŸ¤– Checking Dependabot configuration..."
        if gh api repos/{{.GITHUB_ORG}}/.github/contents/.github/dependabot.yml >/dev/null 2>&1; then
          echo "âœ… Dependabot configuration found"
        else
          echo "âŒ Dependabot configuration not found"
        fi
        
        echo "âœ… GitHub verification complete"

  validate-all:
    desc: Run all validation checks (local + GitHub)
    cmds:
      - task: check
      - task: verify-github

  status:
    desc: Show current system status and health
    cmds:
      - |
        echo "ğŸ¢ GitHub Organization: {{.GITHUB_ORG}}"
        echo "ğŸ“ Repository: https://github.com/{{.GITHUB_ORG}}/.github"
        echo "ğŸŒ Platform: {{.OS}}/{{.ARCH}}"
        echo ""
        echo "ğŸ“Š System Status:"
        
        # Check if files are generated
        if [ -d ".github" ]; then
          echo "âœ… Generated files exist"
        else
          echo "âŒ Generated files missing - run 'task setup'"
        fi
        
        # Check if files are up to date (quick check)
        if task check >/dev/null 2>&1; then
          echo "âœ… Generated files are up to date"
        else
          echo "âš ï¸  Generated files may be out of date - run 'task check' for details"
        fi
        
        # Check Go module
        if go mod verify >/dev/null 2>&1; then
          echo "âœ… Go module verified"
        else
          echo "âŒ Go module issues - run 'go mod tidy'"
        fi
        
        # Platform-aware GitHub CLI check
        if command -v {{.GH_BINARY}} >/dev/null 2>&1; then
          echo "âœ… GitHub CLI available: $({{.GH_BINARY}} --version | head -1 | cut -d' ' -f3)"
        else
          echo "âŒ GitHub CLI not installed - run 'task install-gh'"
        fi
        
        # Platform-specific checks
        {{if eq .OS "darwin"}}
        # macOS specific checks
        if command -v brew >/dev/null 2>&1; then
          echo "âœ… Homebrew available"
        else
          echo "âš ï¸  Homebrew not installed (recommended for macOS)"
        fi
        {{else if eq .OS "linux"}}
        # Linux specific checks
        if systemctl --version >/dev/null 2>&1; then
          echo "âœ… Systemd available"
        else
          echo "â„¹ï¸  Systemd not available (using alternative service management)"
        fi
        {{else if eq .OS "windows"}}
        # Windows specific checks  
        if command -v choco >/dev/null 2>&1; then
          echo "âœ… Chocolatey available"
        elif command -v scoop >/dev/null 2>&1; then
          echo "âœ… Scoop available"
        elif command -v winget >/dev/null 2>&1; then
          echo "âœ… Winget available"
        else
          echo "âš ï¸  No package manager found (consider installing Chocolatey/Scoop/Winget)"
        fi
        {{end}}

  dev:
    desc: Development workflow - clean, setup, and check
    cmds:
      - echo "ğŸš€ Running development workflow..."
      - task: clean
      - task: setup
      - task: check
      - echo "âœ… Development workflow complete"

  help:
    desc: Show detailed help and usage examples
    cmds:
      - |
        echo "ğŸ› ï¸  GitHub Organization Setup Tool"
        echo "=================================="
        echo ""
        echo "ğŸ“‹ Quick Start:"
        echo "  task setup     # Generate all files"
        echo "  task status    # Check system health"
        echo "  task dev       # Development workflow"
        echo ""
        echo "ğŸ” Validation:"
        echo "  task check           # Check local files vs templates"
        echo "  task verify-github   # Check GitHub state"
        echo "  task validate-all    # Run all checks"
        echo ""
        echo "ğŸ§¹ Maintenance:"
        echo "  task clean       # Remove generated files"
        echo "  task install-gh  # Install GitHub CLI"
        echo ""
        echo "ğŸš€ NATS Integration:"
        echo "  task nats-monitor        # Monitor NATS-powered workflows"
        echo "  task nats-deploy         # Deploy NATS infrastructure"
        echo "  task nats-scale          # Scale NATS infrastructure"
        echo "  task nats-controller     # Run NATS controller locally"
        echo ""
        echo "ğŸ Bee Integration:"
        echo "  task bee-install         # Install bee event system"
        echo "  task bee-generate        # Generate handlers from protobuf"
        echo "  task bee-run             # Run bee orchestrator"
        echo "  task bee-validate        # Validate schemas and config"
        echo "  task bee-demo            # Show bee capabilities"
        echo ""
        echo "ğŸŒ Cross-Platform:"
        echo "  task test-platform       # Test cross-platform compatibility"
        echo "  Platform: {{.OS}}/{{.ARCH}}   # Current platform"
        echo ""
        echo "ğŸ“– Documentation:"
        echo "  README.md        # Architecture and patterns"
        echo "  CONTRIBUTING.md  # Contribution guidelines"
        echo ""
        echo "ğŸŒ Links:"
        echo "  Repository: https://github.com/{{.GITHUB_ORG}}/.github"
        echo "  Profile:    https://github.com/{{.GITHUB_ORG}}?preview=true"
        echo "  Workflows:  https://github.com/{{.GITHUB_ORG}}/.github/actions"

  monitor-workflow:
    desc: Monitor GitHub Actions workflow execution
    cmds:
      - |
        echo "ğŸ” Monitoring GitHub Actions workflow for template changes..."
        echo "This script monitors the full cycle: template change â†’ GitHub Actions â†’ file regeneration"
        echo ""
        ./monitor-workflow.sh

  monitor-nats:
    desc: Monitor workflow using NATS (requires NATS server)
    cmds:
      - |
        echo "ğŸš€ NATS-enhanced workflow monitoring"
        echo "This demonstrates advanced patterns for workflow orchestration"
        echo ""
        ./nats-monitor.sh check

  nats-demo:
    desc: Show NATS enhanced workflow capabilities
    cmds:
      - |
        echo "ğŸŒŸ NATS Enhanced GitHub Workflow Demonstration"
        echo "=============================================="
        echo ""
        ./nats-monitor.sh demo

  nats-controller:
    desc: Start the NATS-based workflow controller (requires NATS server)
    cmds:
      - |
        echo "ğŸ›ï¸  Starting NATS workflow controller..."
        go mod download
        go run cmd/nats-controller/main.go

  nats-monitor:
    desc: Monitor NATS-powered GitHub workflows
    cmds:
      - |
        echo "ğŸ” NATS Workflow Monitor for {{.GITHUB_ORG}}"
        echo "==========================================="
        
        if [ -f "nats-monitor.sh" ]; then
          chmod +x nats-monitor.sh
          ./nats-monitor.sh
        else
          echo "âŒ nats-monitor.sh not found"
          echo "   This would connect to Synadia Cloud and monitor:"
          echo "   â€¢ github.{{.GITHUB_ORG}}.template_changed"
          echo "   â€¢ github.{{.GITHUB_ORG}}.workflow_status"
          echo "   â€¢ github.{{.GITHUB_ORG}}.regeneration_requested"
          echo ""
          echo "   To enable NATS monitoring:"
          echo "   1. Sign up for Synadia Cloud"
          echo "   2. Configure credentials"
          echo "   3. Run: task nats-deploy"
        fi

  nats-deploy:
    desc: Deploy NATS infrastructure using Terraform
    cmds:
      - |
        echo "ğŸš€ Deploying NATS Infrastructure"
        echo "================================"
        
        if ! command -v terraform >/dev/null 2>&1; then
          echo "âŒ Terraform not installed"
          echo "   Install from: https://www.terraform.io/downloads"
          exit 1
        fi
        
        cd terraform
        
        echo "ğŸ“‹ Initializing Terraform..."
        terraform init
        
        echo "ğŸ“‹ Planning NATS infrastructure..."
        terraform plan -var="github_org={{.GITHUB_ORG}}"
        
        echo ""
        echo "To apply:"
        echo "  cd terraform && terraform apply -var='github_org={{.GITHUB_ORG}}'"

  nats-scale:
    desc: Scale NATS infrastructure based on load
    cmds:
      - |
        echo "ğŸ“ˆ NATS Infrastructure Scaling"
        echo "=============================="
        
        echo "This would:"
        echo "1. Check current GitHub event load"
        echo "2. Analyze NATS queue depths"
        echo "3. Trigger Terraform for additional capacity"
        echo "4. Auto-configure new NATS nodes"
        echo ""
        echo "Example scaling triggers:"
        echo "â€¢ Queue depth > 1000 messages"
        echo "â€¢ Processing latency > 30 seconds"
        echo "â€¢ GitHub API rate limit approaching"
        echo ""
        echo "Self-similar pattern: NATS controllers deploy more NATS!"

  nats-controller:
    desc: Run NATS controller locally for development
    cmds:
      - |
        echo "ğŸ¤– Starting Local NATS Controller"
        echo "================================="
        
        if [ ! -f "cmd/nats-controller/main.go" ]; then
          echo "âŒ NATS controller not found"
          exit 1
        fi
        
        echo "ğŸ“‹ Environment:"
        echo "  GITHUB_ORG: {{.GITHUB_ORG}}"
        echo "  NATS_URL: ${NATS_URL:-nats://localhost:4222}"
        echo ""
        
        if ! command -v {{.NATS_BINARY}} >/dev/null 2>&1; then
          echo "âš ï¸  NATS CLI not installed"
          echo "   Install from: https://github.com/nats-io/natscli"
          echo "   Or use Docker: docker run natsio/nats-server"
        fi
        
        echo "ğŸš€ Starting controller..."
        go run cmd/nats-controller/main.go

  bee-install:
    desc: Install bee for event-driven GitHub workflows
    cmds:
      - |
        echo "ğŸ Installing bee for event-driven workflows"
        echo "============================================"
        
        if command -v bee >/dev/null 2>&1; then
          echo "âœ… bee already installed: $(bee version)"
        else
          echo "ğŸ“¦ Installing bee..."
          go install github.com/blinkinglight/bee/cmd/bee@latest
          
          if command -v bee >/dev/null 2>&1; then
            echo "âœ… bee installed: $(bee version)"
          else
            echo "âŒ bee installation failed"
            echo "   Try manual installation: https://github.com/blinkinglight/bee"
            exit 1
          fi
        fi

  bee-generate:
    desc: Generate bee handlers from protobuf schemas
    deps: [bee-install]
    cmds:
      - |
        echo "ğŸ”§ Generating bee handlers from protobuf schemas"
        echo "==============================================="
        
        if [ ! -f "schemas/github_events.proto" ]; then
          echo "âŒ Protobuf schema not found: schemas/github_events.proto"
          exit 1
        fi
        
        echo "ğŸ“‹ Generating Go code from protobuf..."
        
        # Create output directory
        mkdir -p pkg/events/v1
        
        # Generate protobuf Go code
        if command -v protoc >/dev/null 2>&1; then
          protoc --go_out=pkg/events/v1 --go_opt=paths=source_relative schemas/github_events.proto
          echo "âœ… Protobuf Go code generated"
        else
          echo "âš ï¸  protoc not installed, skipping protobuf generation"
          echo "   Install from: https://protobuf.dev/downloads/"
        fi
        
        echo "ğŸ Generating bee handlers..."
        bee generate --config bee.yaml
        
        echo "âœ… bee handler generation complete"

  bee-run:
    desc: Run bee-powered GitHub workflow orchestrator
    deps: [bee-generate]
    cmds:
      - |
        echo "ğŸ Starting bee GitHub Workflow Orchestrator"
        echo "==========================================="
        
        if [ ! -f "bee.yaml" ]; then
          echo "âŒ bee configuration not found: bee.yaml"
          exit 1
        fi
        
        echo "ğŸ“‹ Configuration:"
        echo "  GITHUB_ORG: {{.GITHUB_ORG}}"
        echo "  NATS_URL: ${NATS_URL:-nats://localhost:4222}"
        echo "  Config: bee.yaml"
        echo ""
        
        echo "ğŸš€ Starting bee orchestrator..."
        bee run --config bee.yaml

  bee-validate:
    desc: Validate bee configuration and schemas
    deps: [bee-install]
    cmds:
      - |
        echo "ğŸ” Validating bee configuration and schemas"
        echo "=========================================="
        
        if [ ! -f "bee.yaml" ]; then
          echo "âŒ bee configuration not found: bee.yaml"
          exit 1
        fi
        
        echo "ğŸ“‹ Validating bee.yaml configuration..."
        bee validate --config bee.yaml
        
        if [ -f "schemas/github_events.proto" ]; then
          echo "ğŸ“‹ Validating protobuf schema..."
          if command -v protoc >/dev/null 2>&1; then
            protoc --descriptor_set_out=/dev/null schemas/github_events.proto
            echo "âœ… Protobuf schema is valid"
          else
            echo "âš ï¸  protoc not installed, skipping schema validation"
          fi
        fi
        
        echo "âœ… All validations passed"

  bee-demo:
    desc: Demonstrate bee integration capabilities
    cmds:
      - |
        echo "ğŸŒŸ Bee + NATS + GitHub Integration Demo"
        echo "======================================"
        echo ""
        echo "ğŸ Bee brings to our GitHub workflow orchestration:"
        echo ""
        echo "ğŸ“‹ Type-Safe Event Handling:"
        echo "  â€¢ Protobuf schemas define all GitHub events"
        echo "  â€¢ Generated Go handlers with compile-time safety"
        echo "  â€¢ Schema evolution without breaking changes"
        echo ""
        echo "ğŸ”„ Event-Driven Architecture:"
        echo "  â€¢ GitHub webhooks â†’ Protobuf events â†’ NATS â†’ bee handlers"
        echo "  â€¢ Terraform operations triggered by events"
        echo "  â€¢ Self-healing infrastructure through event sourcing"
        echo ""
        echo "ğŸš€ Advanced Features:"
        echo "  â€¢ Built-in metrics and tracing"
        echo "  â€¢ Event replay for debugging"
        echo "  â€¢ Rate limiting and backpressure"
        echo "  â€¢ Multi-language support (Go, Rust, Python)"
        echo ""
        echo "ğŸ”§ Self-Terraforming Pattern:"
        echo "  â€¢ bee handlers detect infrastructure needs"
        echo "  â€¢ Automatically trigger Terraform operations"
        echo "  â€¢ NATS controllers deploy more NATS infrastructure"
        echo "  â€¢ Self-similar scaling across regions"
        echo ""
        echo "ğŸ“Š Observability:"
        echo "  â€¢ Prometheus metrics for all events"
        echo "  â€¢ Jaeger tracing for distributed debugging"
        echo "  â€¢ Structured logging with correlation IDs"
        echo ""
        echo "ğŸŒ Getting Started:"
        echo "  task bee-install     # Install bee"
        echo "  task bee-generate    # Generate handlers"
        echo "  task bee-run         # Start orchestrator"
        echo ""
        echo "This represents the next evolution of GitHub workflow"
        echo "orchestration - event-driven, type-safe, and infinitely scalable! ğŸğŸš€"