version: '3'

# View organization profile at: https://github.com/joeblew999?preview=true

vars:
  GITHUB_ORG: joeblew999

tasks:
  default:
    desc: List available tasks
    cmds:
      - task --list

  setup:
    desc: Create .github structure from templates
    cmds:
      - task: clean
      - mkdir -p .github profile
      - go run cmd/github-setup/main.go -org={{.GITHUB_ORG}}

  clean:
    desc: Remove generated .github files
    cmds:
      - rm -rf .github/ISSUE_TEMPLATE .github/issue-templates .github/workflows .github/CODEOWNERS .github/dependabot.yml .github/pull_request_template.md .github/PULL_REQUEST_TEMPLATE

  check:
    desc: Check if generated files are up to date with templates
    cmds:
      - |
        echo "Checking if generated files are up to date..."
        TEMP_DIR=$(mktemp -d)
        go run cmd/github-setup/main.go -org={{.GITHUB_ORG}} -output="$TEMP_DIR"
        if ! diff -r .github "$TEMP_DIR" > /dev/null 2>&1; then
          echo "âŒ Generated files are out of date. Run 'task setup' to update."
          rm -rf "$TEMP_DIR"
          exit 1
        else
          echo "âœ… Generated files are up to date."
          rm -rf "$TEMP_DIR"
        fi

  install-gh:
    desc: Ensure GitHub CLI is installed (idempotent)
    cmds:
      - |
        if command -v gh >/dev/null 2>&1; then
          echo "âœ… GitHub CLI already installed: $(gh --version | head -1)"
        else
          echo "ðŸ“¦ Installing GitHub CLI..."
          if [[ "$OSTYPE" == "darwin"* ]]; then
            brew install gh
          elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install gh
          else
            echo "âŒ Unsupported OS. Please install GitHub CLI manually: https://cli.github.com/"
            exit 1
          fi
          echo "âœ… GitHub CLI installed: $(gh --version | head -1)"
        fi

  verify-github:
    desc: Verify repository state on GitHub matches local templates
    deps: [install-gh]
    cmds:
      - |
        echo "ðŸ” Verifying GitHub repository state..."
        
        # Check if repo exists and is accessible
        if ! gh repo view {{.GITHUB_ORG}}/.github >/dev/null 2>&1; then
          echo "âŒ Cannot access repository {{.GITHUB_ORG}}/.github"
          exit 1
        fi
        
        echo "âœ… Repository {{.GITHUB_ORG}}/.github is accessible"
        
        # Check if workflows are enabled
        echo "ðŸ“‹ Checking workflows..."
        gh workflow list --repo {{.GITHUB_ORG}}/.github
        
        # Check if issues/PRs use our templates
        echo "ðŸ“ Checking if templates are active..."
        echo "  Issue templates:"
        gh api repos/{{.GITHUB_ORG}}/.github/contents/.github/ISSUE_TEMPLATE --jq '.[].name' 2>/dev/null || \
        gh api repos/{{.GITHUB_ORG}}/.github/contents/.github/issue-templates --jq '.[].name' 2>/dev/null || \
        echo "    No issue templates found"
        
        # Check organization profile
        echo "ðŸ¢ Organization profile:"
        gh api orgs/{{.GITHUB_ORG}} --jq '.name // .login' 2>/dev/null || \
        echo "    Organization API requires admin:org scope"
        
        # Check if dependabot is configured
        echo "ðŸ¤– Checking Dependabot configuration..."
        if gh api repos/{{.GITHUB_ORG}}/.github/contents/.github/dependabot.yml >/dev/null 2>&1; then
          echo "âœ… Dependabot configuration found"
        else
          echo "âŒ Dependabot configuration not found"
        fi
        
        echo "âœ… GitHub verification complete"

  validate-all:
    desc: Run all validation checks (local + GitHub)
    cmds:
      - task: check
      - task: verify-github

  status:
    desc: Show current system status and health
    cmds:
      - |
        echo "ðŸ¢ GitHub Organization: {{.GITHUB_ORG}}"
        echo "ðŸ“ Repository: https://github.com/{{.GITHUB_ORG}}/.github"
        echo ""
        echo "ðŸ“Š System Status:"
        
        # Check if files are generated
        if [ -d ".github" ]; then
          echo "âœ… Generated files exist"
        else
          echo "âŒ Generated files missing - run 'task setup'"
        fi
        
        # Check if files are up to date (quick check)
        if task check >/dev/null 2>&1; then
          echo "âœ… Generated files are up to date"
        else
          echo "âš ï¸  Generated files may be out of date - run 'task check' for details"
        fi
        
        # Check Go module
        if go mod verify >/dev/null 2>&1; then
          echo "âœ… Go module verified"
        else
          echo "âŒ Go module issues - run 'go mod tidy'"
        fi
        
        # Check GitHub CLI
        if command -v gh >/dev/null 2>&1; then
          echo "âœ… GitHub CLI available: $(gh --version | head -1 | cut -d' ' -f3)"
        else
          echo "âŒ GitHub CLI not installed - run 'task install-gh'"
        fi

  dev:
    desc: Development workflow - clean, setup, and check
    cmds:
      - echo "ðŸš€ Running development workflow..."
      - task: clean
      - task: setup
      - task: check
      - echo "âœ… Development workflow complete"

  help:
    desc: Show detailed help and usage examples
    cmds:
      - |
        echo "ðŸ› ï¸  GitHub Organization Setup Tool"
        echo "=================================="
        echo ""
        echo "ðŸ“‹ Quick Start:"
        echo "  task setup     # Generate all files"
        echo "  task status    # Check system health"
        echo "  task dev       # Development workflow"
        echo ""
        echo "ðŸ” Validation:"
        echo "  task check           # Check local files vs templates"
        echo "  task verify-github   # Check GitHub state"
        echo "  task validate-all    # Run all checks"
        echo ""
        echo "ðŸ§¹ Maintenance:"
        echo "  task clean       # Remove generated files"
        echo "  task install-gh  # Install GitHub CLI"
        echo ""
        echo "ðŸ“– Documentation:"
        echo "  README.md        # Architecture and patterns"
        echo "  CONTRIBUTING.md  # Contribution guidelines"
        echo ""
        echo "ðŸŒ Links:"
        echo "  Repository: https://github.com/{{.GITHUB_ORG}}/.github"
        echo "  Profile:    https://github.com/{{.GITHUB_ORG}}?preview=true"
        echo "  Workflows:  https://github.com/{{.GITHUB_ORG}}/.github/actions"

  monitor:
    desc: Monitor GitHub Actions workflow after template changes
    deps: [install-gh]
    cmds:
      - ./monitor-workflow.sh

  test-workflow:
    desc: Test the full template â†’ GitHub Actions â†’ regeneration workflow
    deps: [install-gh]
    cmds:
      - |
        echo "ðŸ§ª Testing Template â†’ GitHub Actions â†’ Regeneration Workflow"
        echo "==========================================================="
        echo ""
        echo "This test will:"
        echo "1. ðŸ“ Add a timestamp to a template"
        echo "2. ðŸš€ Commit and push the change"
        echo "3. ðŸ‘€ Monitor GitHub Actions execution"
        echo "4. âœ… Verify files regenerate automatically"
        echo ""
        read -p "Continue with workflow test? (y/n): " -n 1 -r
        echo
        if [[ $$REPLY =~ ^[Yy]$$ ]]; then
          echo "Adding test timestamp to PR template..."
          echo "" >> templates/pull_request_template.md
          echo "<!-- Test timestamp: $(date) -->" >> templates/pull_request_template.md
          git add templates/pull_request_template.md
          git commit -m "test: add timestamp to PR template - workflow test"
          git push
          echo ""
          echo "ðŸ”„ Change pushed! Monitoring workflow..."
          sleep 5
          ./monitor-workflow.sh
        else
          echo "Test cancelled."
        fi